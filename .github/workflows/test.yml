name: Test

# This workflow uses uv for dependency management and testing across Python versions
# Matrix strategy tests Python 3.8-3.13 with websockets versions 10-15
# Allure results are stored in: allure-results/py{python-version}-websockets{websockets-version}/

on:
  push:
    branches: [ main, master, develop, feature/*, fix/* ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  # Minimal test matrix for pushes - only test latest websockets version per Python version
  test-push:
    if: github.event_name == 'push'
    name: Test Python ${{ matrix.python-version }} with websockets ${{ matrix.websockets-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Each Python version with its latest supported websockets version
          - python-version: "3.8"
            websockets-version: "13"
            websockets-constraint: ">=13.0,<14.0"
          - python-version: "3.9"
            websockets-version: "13"
            websockets-constraint: ">=13.0,<14.0"
          - python-version: "3.10"
            websockets-version: "15"
            websockets-constraint: ">=15.0,<16.0"
          - python-version: "3.11"
            websockets-version: "15"
            websockets-constraint: ">=15.0,<16.0"
          - python-version: "3.12"
            websockets-version: "15"
            websockets-constraint: ">=15.0,<16.0"
          - python-version: "3.13"
            websockets-version: "15"
            websockets-constraint: ">=15.0,<16.0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v5

      - name: Run tests with uv
        run: |
          uv run --python ${{ matrix.python-version }} -g test --with "websockets${{ matrix.websockets-constraint }}" pytest -m "not integration" --alluredir=allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }} tests
        env:
          WEBSOCKETS_VERSION: ${{ matrix.websockets-version }}
          PYTHON_VERSION: ${{ matrix.python-version }}
          TEST_ENV_NAME: py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}

      - name: Upload coverage reports (if available)
        if: always()
        continue-on-error: true
        run: |
          if [ -f .coverage ]; then
            uvx coverage report
          fi

  # Full test matrix for pull requests
  test-pr:
    if: github.event_name == 'pull_request'
    name: Test Python ${{ matrix.python-version }} with websockets ${{ matrix.websockets-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Python 3.8 with websockets 10-13
          - python-version: "3.8"
            websockets-version: "10"
            websockets-constraint: ">=10.0,<11.0"
          - python-version: "3.8"
            websockets-version: "11"
            websockets-constraint: ">=11.0,<12.0"
          - python-version: "3.8"
            websockets-version: "12"
            websockets-constraint: ">=12.0,<13.0"
          - python-version: "3.8"
            websockets-version: "13"
            websockets-constraint: ">=13.0,<14.0"
          
          # Python 3.9 with websockets 10-13
          - python-version: "3.9"
            websockets-version: "10"
            websockets-constraint: ">=10.0,<11.0"
          - python-version: "3.9"
            websockets-version: "11"
            websockets-constraint: ">=11.0,<12.0"
          - python-version: "3.9"
            websockets-version: "12"
            websockets-constraint: ">=12.0,<13.0"
          - python-version: "3.9"
            websockets-version: "13"
            websockets-constraint: ">=13.0,<14.0"
          
          # Python 3.10 with websockets 10-15
          - python-version: "3.10"
            websockets-version: "10"
            websockets-constraint: ">=10.0,<11.0"
          - python-version: "3.10"
            websockets-version: "11"
            websockets-constraint: ">=11.0,<12.0"
          - python-version: "3.10"
            websockets-version: "12"
            websockets-constraint: ">=12.0,<13.0"
          - python-version: "3.10"
            websockets-version: "13"
            websockets-constraint: ">=13.0,<14.0"
          - python-version: "3.10"
            websockets-version: "14"
            websockets-constraint: ">=14.0,<15.0"
          - python-version: "3.10"
            websockets-version: "15"
            websockets-constraint: ">=15.0,<16.0"
          
          # Python 3.11 with websockets 10-15
          - python-version: "3.11"
            websockets-version: "10"
            websockets-constraint: ">=10.0,<11.0"
          - python-version: "3.11"
            websockets-version: "11"
            websockets-constraint: ">=11.0,<12.0"
          - python-version: "3.11"
            websockets-version: "12"
            websockets-constraint: ">=12.0,<13.0"
          - python-version: "3.11"
            websockets-version: "13"
            websockets-constraint: ">=13.0,<14.0"
          - python-version: "3.11"
            websockets-version: "14"
            websockets-constraint: ">=14.0,<15.0"
          - python-version: "3.11"
            websockets-version: "15"
            websockets-constraint: ">=15.0,<16.0"
          
          # Python 3.12 with websockets 10-15
          - python-version: "3.12"
            websockets-version: "10"
            websockets-constraint: ">=10.0,<11.0"
          - python-version: "3.12"
            websockets-version: "11"
            websockets-constraint: ">=11.0,<12.0"
          - python-version: "3.12"
            websockets-version: "12"
            websockets-constraint: ">=12.0,<13.0"
          - python-version: "3.12"
            websockets-version: "13"
            websockets-constraint: ">=13.0,<14.0"
          - python-version: "3.12"
            websockets-version: "14"
            websockets-constraint: ">=14.0,<15.0"
          - python-version: "3.12"
            websockets-version: "15"
            websockets-constraint: ">=15.0,<16.0"
          
          # Python 3.13 with websockets 10-15
          - python-version: "3.13"
            websockets-version: "10"
            websockets-constraint: ">=10.0,<11.0"
          - python-version: "3.13"
            websockets-version: "11"
            websockets-constraint: ">=11.0,<12.0"
          - python-version: "3.13"
            websockets-version: "12"
            websockets-constraint: ">=12.0,<13.0"
          - python-version: "3.13"
            websockets-version: "13"
            websockets-constraint: ">=13.0,<14.0"
          - python-version: "3.13"
            websockets-version: "14"
            websockets-constraint: ">=14.0,<15.0"
          - python-version: "3.13"
            websockets-version: "15"
            websockets-constraint: ">=15.0,<16.0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v5

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Run tests with uv
        run: |
          echo "=== Running tests with uv ==="
          echo "Current working directory: $(pwd)"
          echo "Python version: ${{ matrix.python-version }}"
          echo "Websockets version: ${{ matrix.websockets-version }}"
          echo "Test environment: py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}"
          uv run --python ${{ matrix.python-version }} -g test --with "websockets${{ matrix.websockets-constraint }}" pytest --alluredir=allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }} tests
          echo "Tests completed with exit code: $?"
        env:
          WEBSOCKETS_VERSION: ${{ matrix.websockets-version }}
          PYTHON_VERSION: ${{ matrix.python-version }}
          TEST_ENV_NAME: py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}

      - name: Debug - After test execution
        run: |
          echo "=== After Test Execution Debug ==="
          echo "Current working directory: $(pwd)"
          echo "Test environment: py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}"
          echo "Expected allure results path: allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}/"
          echo "Looking for allure-results directories:"
          find . -name "allure-results" -type d 2>/dev/null || echo "No allure-results directories found"
          echo "Contents of allure-results base directory:"
          ls -la allure-results/ 2>/dev/null || echo "No allure-results base directory"
          echo "Contents of expected test env directory:"
          ls -la allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}/ 2>/dev/null || echo "No allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }} directory"
          echo "JSON files generated in expected directory:"
          find allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}/ -name "*.json" 2>/dev/null | head -10 || echo "No JSON files in allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}"
          echo "XML files generated in expected directory:"
          find allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}/ -name "*.xml" 2>/dev/null | head -10 || echo "No XML files in allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}"

      - name: Upload allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}
          path: allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}/
          retention-days: 7

      - name: Debug - After artifact upload
        if: always()
        run: |
          echo "=== After Artifact Upload Debug ==="
          echo "Current working directory: $(pwd)"
          echo "Artifact name: allure-results-py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}"
          echo "Path being uploaded: allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}/"
          if [ -d "allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}" ]; then
            echo "Final check of allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }} before upload:"
            find allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}/ -type f | head -10
            echo "Total files being uploaded:"
            find allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }}/ -type f | wc -l
          else
            echo "WARNING: allure-results/py${{ matrix.python-version }}-websockets${{ matrix.websockets-version }} directory does not exist for upload!"
          fi
          echo "Available allure-results subdirectories:"
          ls -la allure-results/ 2>/dev/null || echo "No allure-results directory at all!"

      - name: Upload coverage reports (if available)
        if: always()
        continue-on-error: true
        run: |
          if [ -f .coverage ]; then
            uvx coverage report
          fi

  # Generate and deploy allure report
  allure-report:
    if: github.event_name == 'pull_request' && always()
    name: Generate and Deploy Allure Report
    runs-on: ubuntu-latest
    needs: [test-pr]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Initial state
        run: |
          echo "=== Initial Debug Info ==="
          echo "Current working directory: $(pwd)"
          echo "Contents of current directory:"
          ls -la
          echo "Environment variables:"
          env | grep -E "(GITHUB|RUNNER)" | sort

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Debug - Before artifact download
        run: |
          echo "=== Before Artifact Download ==="
          echo "Current working directory: $(pwd)"
          echo "Contents of current directory:"
          ls -la
          echo "Looking for any existing allure-results:"
          find . -name "allure-results" -type d 2>/dev/null || echo "No allure-results directories found"
          find . -name "*.json" 2>/dev/null | head -5 || echo "No JSON files found"

      - name: Download all allure results
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          path: allure-results/
          merge-multiple: true

      - name: Debug - After artifact download
        run: |
          echo "=== After Artifact Download ==="
          echo "Current working directory: $(pwd)"
          echo "Contents of current directory:"
          ls -la
          echo "Contents of allure-results directory (if exists):"
          if [ -d "allure-results" ]; then
            ls -la allure-results/
            echo "Total files in allure-results:"
            find allure-results/ -type f | wc -l
            echo "JSON files in allure-results:"
            find allure-results/ -name "*.json" | wc -l
            echo "First 10 JSON files:"
            find allure-results/ -name "*.json" | head -10
            echo "Sample file sizes:"
            find allure-results/ -name "*.json" -exec ls -lh {} \; | head -5
          else
            echo "allure-results directory does not exist!"
          fi

      - name: List downloaded artifacts
        run: |
          echo "=== Artifact Listing ==="
          echo "JSON files found:"
          find allure-results/ -type f -name "*.json" | head -10 || echo "No JSON files found"
          echo "Total file count:"
          find allure-results/ -type f | wc -l || echo "Could not count files"
          echo "Directory structure:"
          find allure-results/ -type d | head -10 || echo "No directories found"

      - name: Install Allure
        run: |
          echo "=== Installing Allure ==="
          echo "Current working directory: $(pwd)"
          sudo apt-get update
          sudo apt-get install -y openjdk-11-jdk
          echo "Java version:"
          java -version
          echo "Downloading Allure..."
          curl -o allure-2.24.0.tgz -Ls https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
          echo "Extracting Allure..."
          sudo tar -zxvf allure-2.24.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.24.0/bin/allure /usr/bin/allure
          echo "Allure version:"
          allure --version

      - name: Debug - Before report generation
        run: |
          echo "=== Before Report Generation ==="
          echo "Current working directory: $(pwd)"
          echo "Allure results directory structure:"
          if [ -d "allure-results" ]; then
            tree allure-results/ || find allure-results/ -type f -exec echo "File: {}" \;
            echo "Sample content of a JSON file (if any):"
            find allure-results/ -name "*.json" | head -1 | xargs cat || echo "No JSON files to show content"
          else
            echo "No allure-results directory found!"
          fi
          echo "Total size of allure-results:"
          du -sh allure-results/ 2>/dev/null || echo "Could not calculate size"

      - name: Generate Allure Report
        run: |
          echo "=== Generating Allure Report ==="
          echo "Current working directory: $(pwd)"
          echo "Running allure generate command..."
          allure generate allure-results/ --clean -o allure-report/
          echo "Allure generate completed with exit code: $?"
          echo "Contents of allure-report directory:"
          if [ -d "allure-report" ]; then
            ls -la allure-report/
            echo "Total files in report:"
            find allure-report/ -type f | wc -l
            echo "Report size:"
            du -sh allure-report/
          else
            echo "allure-report directory was not created!"
          fi
          
      - name: Debug - After report generation
        run: |
          echo "=== After Report Generation ==="
          echo "Current working directory: $(pwd)"
          echo "Directory listing:"
          ls -la
          if [ -d "allure-report" ]; then
            echo "Allure report directory contents:"
            find allure-report/ -name "*.html" | head -5
            echo "Index.html exists:"
            [ -f "allure-report/index.html" ] && echo "YES" || echo "NO"
            if [ -f "allure-report/index.html" ]; then
              echo "Index.html size:"
              ls -lh allure-report/index.html
            fi
          else
            echo "No allure-report directory found!"
          fi
          
      - name: Install Vercel CLI
        run: |
          echo "=== Installing Vercel CLI ==="
          echo "Current working directory: $(pwd)"
          npm install -g vercel@latest
          echo "Vercel version:"
          vercel --version

      - name: Debug - Before Vercel deployment
        run: |
          echo "=== Before Vercel Deployment ==="
          echo "Current working directory: $(pwd)"
          echo "Checking allure-report directory before deployment:"
          if [ -d "allure-report" ]; then
            cd allure-report/
            echo "Contents of allure-report directory:"
            ls -la
            echo "Current directory after cd: $(pwd)"
            echo "Main files check:"
            [ -f "index.html" ] && echo "index.html: EXISTS" || echo "index.html: MISSING"
            [ -f "app.js" ] && echo "app.js: EXISTS" || echo "app.js: NOT FOUND"
            echo "Total file count in report:"
            find . -type f | wc -l
            cd ..
          else
            echo "allure-report directory does not exist for deployment!"
          fi

      - name: Deploy to Vercel
        run: |
          echo "=== Deploying to Vercel ==="
          echo "Current working directory: $(pwd)"
          cd allure-report/
          echo "Directory contents before deployment:"
          ls -la
          echo "Deploying with Vercel..."
          vercel --token ${{ secrets.VERCEL_TOKEN }} --prod --yes
          echo "Vercel deployment completed with exit code: $?"
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

  test-summary:
    uses: nntin/d-flows/.github/workflows/step-summary.yml@v0
    needs: [test-push, test-pr, allure-report]
    if: always()
    with:
      title: "Test Execution Summary"
      markdown: |
        ### Test Results
        
        - **Test Push Job**: ${{ needs['test-push'].result == 'success' && '✅ Passed' || needs['test-push'].result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }}
        - **Test PR Job**: ${{ needs['test-pr'].result == 'success' && '✅ Passed' || needs['test-pr'].result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }}
        - **Allure Report Job**: ${{ needs['allure-report'].result == 'success' && '✅ Passed' || needs['allure-report'].result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }}
        
        **Event Type**: `${{ github.event_name }}`
        **Branch**: `${{ github.ref }}`
        
        [View Full Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
      overwrite: true
