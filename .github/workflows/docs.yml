name: Documentation

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment target'
        required: true
        default: 'latest'
        type: choice
        options:
          - latest
          - dev
          - stable
      version:
        description: 'Version number (only for stable deployments)'
        required: false
        type: string

permissions:
  contents: write

concurrency:
  group: docs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-docs:
    runs-on: ubuntu-latest
    outputs:
      deployed-version: ${{ steps.set-version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch gh-pages branch
        run: git fetch origin gh-pages:gh-pages || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e .[docs]

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version and deploy
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TARGET="${{ github.event.inputs.target }}"
            echo "Manual deployment triggered for target: $TARGET"
            if [[ "$TARGET" == "stable" ]]; then
              if [[ -n "${{ github.event.inputs.version }}" ]]; then
                VERSION="${{ github.event.inputs.version }}"
                echo "Deploying stable version: $VERSION"
                echo "DEPLOYED_VERSION=Stable ($VERSION)" >> $GITHUB_ENV
                mike deploy $VERSION stable --push --update-aliases
                mike set-default stable --push
              else
                echo "Error: version input is required for stable deployments"
                exit 1
              fi
            elif [[ "$TARGET" == "latest" ]]; then
              echo "Deploying latest prerelease"
              echo "DEPLOYED_VERSION=Latest (edge)" >> $GITHUB_ENV
              mike deploy edge latest --push --update-aliases
            elif [[ "$TARGET" == "dev" ]]; then
              echo "Deploying dev prerelease"
              echo "DEPLOYED_VERSION=Dev (development)" >> $GITHUB_ENV
              mike deploy development dev --push --update-aliases
            fi
          elif [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "Deploying stable version: $VERSION"
            echo "DEPLOYED_VERSION=Stable ($VERSION)" >> $GITHUB_ENV
            mike deploy $VERSION stable --push --update-aliases
            mike set-default stable --push
          elif [[ $GITHUB_REF == refs/heads/main ]]; then
            echo "Deploying latest prerelease from main"
            echo "DEPLOYED_VERSION=Latest (edge)" >> $GITHUB_ENV
            mike deploy edge latest --push --update-aliases
          elif [[ $GITHUB_REF == refs/heads/develop ]]; then
            echo "Deploying dev prerelease from develop"
            echo "DEPLOYED_VERSION=Dev (development)" >> $GITHUB_ENV
            mike deploy development dev --push --update-aliases
          fi

      - name: Set version output
        id: set-version
        run: echo "version=$DEPLOYED_VERSION" >> $GITHUB_OUTPUT

  docs-summary:
    uses: nntin/d-flows/.github/workflows/step-summary.yml@v0
    needs: deploy-docs
    if: always()
    with:
      title: "Documentation Deployment Summary"
      markdown: |
        ### Documentation Deployment Results
        
        - **Deploy Docs Job**: ${{ needs['deploy-docs'].result == 'success' && '✅ Passed' || '❌ Failed' }}
        
        **Event Type**: `${{ github.event_name }}`
        ${{ github.event_name == 'workflow_dispatch' && format('**Target**: `{0}`', github.event.inputs.target) || '' }}
        ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version != '' && format('**Version**: `{0}`', github.event.inputs.version) || '' }}
        ${{ github.event_name == 'push' && format('**Branch**: `{0}`', github.ref) || '' }}
        
        **Documentation Version Deployed**: ${{ needs.deploy-docs.outputs.deployed-version || 'Unknown' }}
        
        [View Full Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
      overwrite: true
