name: Deploy to VPS

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: false
        default: 'latest'
        type: string
  repository_dispatch:
    types: [deploy]

jobs:
  deploy:
    name: Deploy d_back to VPS
    runs-on: ubuntu-latest
    outputs:
      deployed_version: ${{ steps.extract_version.outputs.stdout }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version to deploy
        id: version
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
            echo "Using version from repository dispatch: $VERSION"
          else
            VERSION="${{ github.event.inputs.version || 'latest' }}"
            echo "Using version from workflow dispatch: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME || 'root' }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "üöÄ Starting deployment of d_back..."
            echo "üìù Event: ${{ github.event_name }}"
            echo "üè∑Ô∏è  Version: ${{ steps.version.outputs.version }}"
            
            # Activate the virtual environment
            echo "üîÑ Activating dbackenv virtual environment..."
            source ~/dbackenv/bin/activate
            
            # Stop the d_back service
            echo "‚èπÔ∏è  Stopping d_back service..."
            sudo systemctl stop d_back || echo "d_back service was not running"
            
            # Wait a moment for the service to fully stop
            sleep 2
            
            # Update pip to latest version in the virtual environment
            echo "‚¨ÜÔ∏è  Updating pip in virtual environment..."
            pip install --upgrade pip
            
            # Install or upgrade d_back package in the virtual environment
            if [ "${{ steps.version.outputs.version }}" = "latest" ]; then
              echo "üì¶ Installing latest version of d_back in virtual environment..."
              pip install --upgrade d_back
            else
              echo "üì¶ Installing d_back version ${{ steps.version.outputs.version }} in virtual environment..."
              pip install d_back==${{ steps.version.outputs.version }}
            fi
            
            # Verify installation in the virtual environment
            echo "‚úÖ Verifying d_back installation in virtual environment..."
            python -c "import d_back; print(f'd_back version: {d_back.__version__}')"
            
            # Start the d_back service
            echo "‚ñ∂Ô∏è  Starting d_back service..."
            sudo systemctl start d_back
            
            # Enable service to start on boot (if not already enabled)
            sudo systemctl enable d_back
            
            # Check service status
            echo "üîç Checking d_back service status..."
            sudo systemctl status d_back --no-pager
            
            # Restart nginx to clear any cached connections and reload config
            echo "üîÑ Restarting nginx..."
            sudo systemctl restart nginx
            
            # Check nginx status
            echo "üîç Checking nginx status..."
            sudo systemctl status nginx --no-pager
            
            # Wait a moment and test if services are responding
            sleep 3
            
            echo "üéâ Deployment completed successfully!"
            echo "üìä Service status summary:"
            sudo systemctl is-active d_back
            sudo systemctl is-active nginx

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME || 'root' }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "üîç Running post-deployment verification..."
            
            # Activate the virtual environment for verification
            echo "üîÑ Activating dbackenv virtual environment for verification..."
            source ~/dbackenv/bin/activate
            
            # Check if d_back service is running
            if sudo systemctl is-active --quiet d_back; then
              echo "‚úÖ d_back service is running"
            else
              echo "‚ùå d_back service is not running"
              sudo systemctl status d_back --no-pager
              exit 1
            fi
            
            # Check if nginx is running
            if sudo systemctl is-active --quiet nginx; then
              echo "‚úÖ nginx service is running"
            else
              echo "‚ùå nginx service is not running"
              sudo systemctl status nginx --no-pager
              exit 1
            fi
            
            # Get the installed version from the virtual environment
            INSTALLED_VERSION=$(python -c "import d_back; print(d_back.__version__)" 2>/dev/null || echo "unknown")
            echo "üì¶ Deployed d_back version: $INSTALLED_VERSION"
            
            echo "‚úÖ Deployment verification completed successfully!"

      - name: Extract Deployed Version
        id: extract_version
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME || 'root' }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          capture_stdout: true
          script: |
            # Activate the virtual environment
            source ~/dbackenv/bin/activate
            
            # Extract and print version
            python -c "import d_back; print(d_back.__version__)"

  build-discord-fields:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    outputs:
      discord_fields: ${{ steps.discord_fields.outputs.fields }}
    
    steps:
      - name: Build Discord Fields
        id: discord_fields
        run: |
          STATUS="${{ needs.deploy.result }}"
          
          # Clean the version string - extract only the first line and remove any extra whitespace
          RAW_VERSION="${{ needs.deploy.outputs.deployed_version || 'unknown' }}"
          CLEAN_VERSION=$(echo "$RAW_VERSION" | head -n 1 | tr -d '\r' | xargs)
          
          # Build JSON fields with readable formatting
          FIELDS=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --arg version "$CLEAN_VERSION" \
            --arg status "$STATUS" \
            --arg event "${{ github.event_name == 'repository_dispatch' && 'Auto Deploy (from publish)' || 'Manual Deploy' }}" \
            --arg actor "${{ github.actor }}" \
            --arg run_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '[
              {"name": "Repository", "value": $repo, "inline": true},
              {"name": "Version", "value": $version, "inline": true},
              {"name": "Status", "value": $status, "inline": true},
              {"name": "Event Type", "value": $event, "inline": true},
              {"name": "Triggered By", "value": ("@" + $actor), "inline": true},
              {"name": "Services", "value": "d_back, nginx", "inline": true},
              {"name": "Workflow Run", "value": ("[View Details](" + $run_url + ")"), "inline": false}
            ]')
          
          # Use delimiter to safely output the multiline JSON
          delimiter="$(openssl rand -hex 8)"
          echo "fields<<${delimiter}" >> $GITHUB_OUTPUT
          echo "$FIELDS" >> $GITHUB_OUTPUT
          echo "${delimiter}" >> $GITHUB_OUTPUT

  notify-deployment:
    uses: nntin/d-flows/.github/workflows/discord-notify.yml@v0
    needs: [deploy, build-discord-fields]
    if: always()
    secrets:
      webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
    with:
      message_type: "embed"
      title: ${{ needs.deploy.result == 'success' && '‚úÖ d_back Deployed Successfully' || '‚ùå d_back Deployment Failed' }}
      description: ${{ needs.deploy.result == 'success' && 'd_back has been successfully deployed to the VPS and all services are running.' || 'The deployment workflow encountered errors. Please check the workflow run for details.' }}
      color: ${{ needs.deploy.result == 'success' && '3066993' || '15158332' }}
      fields: ${{ needs.build-discord-fields.outputs.discord_fields }}

  deployment-summary:
    uses: nntin/d-flows/.github/workflows/step-summary.yml@v0
    needs: deploy
    if: always()
    with:
      title: "Deployment Summary"
      markdown: |
        ### Deployment Results
        
        - ${{ needs.deploy.result == 'success' && '‚úÖ' || '‚ùå' }} Deployment Status: ${{ needs.deploy.result }}
        
        ### Deployment Details
        
        **Version Deployed**: `${{ needs.deploy.outputs.deployed_version || 'unknown' }}`
        **Event Type**: ${{ github.event_name == 'repository_dispatch' && 'Repository Dispatch (Auto Deploy)' || 'Workflow Dispatch (Manual Deploy)' }}
        **Triggered By**: @${{ github.actor }}
        **Services Restarted**: d_back, nginx
        
        ### Service Status
        
        ${{ needs.deploy.result == 'success' && 'All services are running and verified successfully.' || 'Deployment failed. Please check the logs above for details.' }}
        
        [View Full Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
      overwrite: true